<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Teklif Onay</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; color:#111; }
    .wrap { max-width: 1200px; margin: 0 auto; }
    h2 { margin: 0 0 14px; }
    .muted { color:#666; font-size: 14px; margin-bottom: 16px; }
    table { width: 100%; border-collapse: collapse; }
    thead th { text-align:left; background:#f6f6f6; padding: 12px 10px; font-size: 22px; }
    tbody td { padding: 14px 10px; border-bottom: 1px solid #eee; font-size: 22px; vertical-align: middle; }
    .code { font-weight: 900; }
    .center { text-align:center; }
    .right { text-align:right; }
    input[type="number"], input[type="text"]{
      font-size: 20px;
      padding: 10px 12px;
      width: 130px;
      border: 1px solid #777;
      border-radius: 3px;
    }
    input.small { width: 110px; }
    .totalsRow { display:flex; justify-content:flex-end; margin-top: 20px; }
    .totals { width: 520px; }
    .tline{ display:grid; grid-template-columns: 1fr 18px 160px; column-gap: 14px; align-items: baseline; margin: 14px 0; }
    .tlabel{ font-weight: 900; font-size: 28px; text-align:left; }
    .tcolon{ font-weight: 900; font-size: 28px; text-align:center; }
    .tval{ font-weight: 900; font-size: 28px; text-align:right; }
    .actions { display:flex; gap: 18px; justify-content:flex-end; margin-top: 16px; }
    .btn{
      font-size: 20px;
      padding: 14px 26px;
      border-radius: 14px;
      border: 1px solid #222;
      cursor: pointer;
      background:#fff;
    }
    .btn.primary{
      background:#111;
      color:#fff;
      border-color:#111;
    }
    .error { margin-top: 14px; color: #b00020; font-weight: 700; }
    .topinfo { display:flex; justify-content:space-between; align-items:flex-end; margin-bottom: 12px; gap: 12px; }
    .badge { font-size: 14px; background:#f6f6f6; padding: 6px 10px; border-radius: 10px; }
  </style>
</head>
<body>
<div class="wrap">
  <div class="topinfo">
    <div>
      <h2>Teklif Satırları <span class="muted">(iskonto değişince net otomatik, neti istersen elle de değiştir)</span></h2>
      <div class="muted" id="offerMeta"></div>
    </div>
    <div class="badge" id="currencyBadge"></div>
  </div>

  <table>
    <thead>
      <tr>
        <th style="width:18%">Kod</th>
        <th>Ürün</th>
        <th class="center" style="width:8%">Çap</th>
        <th class="center" style="width:8%">Adet</th>
        <th class="right" style="width:12%">Liste Fiyatı</th>
        <th class="center" style="width:12%">İskonto %</th>
        <th class="center" style="width:12%">Net</th>
        <th class="right" style="width:12%">Tutar</th>
      </tr>
    </thead>
    <tbody id="linesBody"></tbody>
  </table>

  <div class="totalsRow">
    <div class="totals">
      <div class="tline">
        <div class="tlabel">Ara Toplam</div><div class="tcolon">:</div><div class="tval" id="subTotal">0,00</div>
      </div>
      <div class="tline">
        <div class="tlabel">KDV %20</div><div class="tcolon">:</div><div class="tval" id="kdv">0,00</div>
      </div>
      <div class="tline">
        <div class="tlabel">Genel Toplam</div><div class="tcolon">:</div><div class="tval" id="grandTotal">0,00</div>
      </div>

      <div class="actions">
        <button class="btn" id="btnRecalc">Yeniden Hesapla</button>
        <button class="btn primary" id="btnApprove">Siparişi Onayla</button>
      </div>
    </div>
  </div>

  <div class="error" id="err"></div>
</div>

<script>
  // ✅ kendi webhookların
  const GET_URL = "https://4idgxnjs.rpcl.app/webhook/offer-get";
  const APPROVE_URL = "https://4idgxnjs.rpcl.app/webhook/offer-approve";

  const qs = new URLSearchParams(location.search);
  const offerId = (qs.get("offerId") || "").trim();
  const adminKey = (qs.get("adminKey") || "").trim();

  const errEl = document.getElementById("err");
  const linesBody = document.getElementById("linesBody");
  const subEl = document.getElementById("subTotal");
  const kdvEl = document.getElementById("kdv");
  const grandEl = document.getElementById("grandTotal");
  const metaEl = document.getElementById("offerMeta");
  const curBadge = document.getElementById("currencyBadge");

  let offer = null;

  function setError(msg){
    errEl.textContent = msg || "";
  }

  // --- sayı parse ---
  function parseTRNumber(v) {
    if (v === null || v === undefined) return 0;
    if (typeof v === "number" && Number.isFinite(v)) return v;

    let s = String(v).trim();
    s = s.replace(/[^\d.,-]/g, "");

    if (s.includes(".") && s.includes(",")) {
      s = s.replace(/\./g, "").replace(",", ".");
    } else if (s.includes(",")) {
      s = s.replace(",", ".");
    }

    const n = Number(s);
    return Number.isFinite(n) ? n : 0;
  }

  function fmtTR(n){
    const x = Number(n || 0);
    return x.toFixed(2).replace(".", ",");
  }

  function cur(){
    return (offer && offer.currency) ? offer.currency : "€";
  }

  // ✅ ilk yüklemede “tutar = net*adet” doldur
  function hydrateLines(offerObj){
    offerObj.lines = (offerObj.lines || []).map(l => {
      const adet = parseTRNumber(l.adet);
      const liste = parseTRNumber(l.liste);
      const iskonto = parseTRNumber(l.iskonto);
      const net = parseTRNumber(l.net);

      // ilk açılışta tutar boş/string bile olsa: yeniden hesapla
      const tutar = net * adet;

      return { ...l, adet, liste, iskonto, net, tutar };
    });
  }

  function computeNetFromDiscount(l){
    // liste fiyatı varsa iskonto ile net
    const liste = parseTRNumber(l.liste);
    const isk = parseTRNumber(l.iskonto);
    const net = liste * (1 - (isk/100));
    return net;
  }

  function recalcLineTotals(){
    (offer.lines || []).forEach(l => {
      // manualNet false ise iskonto değişince net otomatik
      if (!l.manualNet) {
        l.net = computeNetFromDiscount(l);
      }
      l.tutar = parseTRNumber(l.net) * parseTRNumber(l.adet);
    });
  }

  function recalcTotals(){
    const sub = (offer.lines || []).reduce((sum, l) => sum + parseTRNumber(l.tutar), 0);
    const kdv = sub * 0.20;
    const gen = sub + kdv;

    subEl.textContent = `${fmtTR(sub)} ${cur()}`;
    kdvEl.textContent = `${fmtTR(kdv)} ${cur()}`;
    grandEl.textContent = `${fmtTR(gen)} ${cur()}`;

    // offer.total da güncelle (backend isterse diye)
    offer.total = sub;
  }

  function render(){
    linesBody.innerHTML = "";

    (offer.lines || []).forEach((l, idx) => {
      const tr = document.createElement("tr");

      const tdKod = document.createElement("td");
      tdKod.className = "code";
      tdKod.textContent = l.kod || "";
      tr.appendChild(tdKod);

      const tdUrun = document.createElement("td");
      tdUrun.textContent = l.urun || "";
      tr.appendChild(tdUrun);

      const tdCap = document.createElement("td");
      tdCap.className = "center";
      tdCap.textContent = l.cap || "";
      tr.appendChild(tdCap);

      const tdAdet = document.createElement("td");
      tdAdet.className = "center";
      tdAdet.textContent = String(parseTRNumber(l.adet));
      tr.appendChild(tdAdet);

      const tdListe = document.createElement("td");
      tdListe.className = "right";
      tdListe.textContent = `${fmtTR(l.liste)} ${cur()}`;
      tr.appendChild(tdListe);

      const tdIsk = document.createElement("td");
      tdIsk.className = "center";
      const iskInp = document.createElement("input");
      iskInp.type = "number";
      iskInp.className = "small";
      iskInp.min = "0";
      iskInp.max = "100";
      iskInp.step = "1";
      iskInp.value = String(parseTRNumber(l.iskonto));

      iskInp.addEventListener("input", () => {
        l.iskonto = parseTRNumber(iskInp.value);
        l.manualNet = false;     // ✅ iskonto değiştiyse net otomatik moda dön
        recalcLineTotals();
        render();                // satırları güncelle
        recalcTotals();
      });

      tdIsk.appendChild(iskInp);
      tr.appendChild(tdIsk);

      const tdNet = document.createElement("td");
      tdNet.className = "center";
      const netInp = document.createElement("input");
      netInp.type = "number";
      netInp.step = "0.01";
      netInp.value = String(parseTRNumber(l.net).toFixed(2));
      netInp.addEventListener("input", () => {
        l.net = parseTRNumber(netInp.value);
        l.manualNet = true;      // ✅ net elle değişti
        l.tutar = parseTRNumber(l.net) * parseTRNumber(l.adet);
        render();
        recalcTotals();
      });
      tdNet.appendChild(netInp);
      tr.appendChild(tdNet);

      const tdTutar = document.createElement("td");
      tdTutar.className = "right";
      tdTutar.textContent = `${fmtTR(l.tutar)} ${cur()}`;
      tr.appendChild(tdTutar);

      linesBody.appendChild(tr);
    });

    curBadge.textContent = `Para birimi: ${cur()}`;
    metaEl.textContent = `offerId: ${offer.offerId || ""} • status: ${offer.status || ""}`;
  }

  async function loadOffer(){
    setError("");
    if (!offerId) return setError("offerId eksik");
    if (!adminKey) return setError("adminKey eksik");

    const url = `${GET_URL}?offerId=${encodeURIComponent(offerId)}&adminKey=${encodeURIComponent(adminKey)}`;
    const res = await fetch(url, { method: "GET" });

    const text = await res.text();
    let data;
    try { data = JSON.parse(text); } catch(e){
      console.error("Bad JSON:", text);
      return setError("Teklif verisi JSON değil (offer-get response kontrol et).");
    }

    if (!data || !data.success || !data.offer) return setError("Teklif verisi alınamadı.");

    offer = data.offer;

    // ✅ kritik: ilk yüklemede satırlar numeric + tutar hesaplı
    hydrateLines(offer);

    // ✅ toplamlar hemen doğru gelsin
    recalcLineTotals();
    render();
    recalcTotals();
  }

  async function approve(){
    setError("");
    if (!offer) return;

    const payload = {
      offerId: offer.offerId,
      adminKey,
      action: "approve",
      // ✅ senin istediğin gibi lines gönderiyoruz
      lines: (offer.lines || []).map(l => ({
        kod: l.kod,
        urun: l.urun,
        cap: l.cap,
        adet: parseTRNumber(l.adet),
        liste: parseTRNumber(l.liste),
        iskonto: parseTRNumber(l.iskonto),
        net: parseTRNumber(l.net),
        tutar: parseTRNumber(l.tutar),
        manualNet: !!l.manualNet
      })),
      total: parseTRNumber(offer.total),
      currency: cur(),
      phone: offer.phone || "",
      customerName: offer.customerName || ""
    };

    const res = await fetch(APPROVE_URL, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });

    const txt = await res.text();
    let out;
    try { out = JSON.parse(txt); } catch(e){ out = null; }

    if (!res.ok) {
      console.error(txt);
      return setError("Onay başarısız: " + (out?.message || txt));
    }

    alert("Sipariş onaylandı ✅");
  }

  document.getElementById("btnRecalc").addEventListener("click", () => {
    if (!offer) return;
    recalcLineTotals();
    render();
    recalcTotals();
  });

  document.getElementById("btnApprove").addEventListener("click", approve);

  loadOffer().catch(e => {
    console.error(e);
    setError("Teklif yüklenemedi: " + (e?.message || String(e)));
  });
</script>
</body>
</html>