<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Teklif Onay</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:20px;color:#111}
    .wrap{max-width:1100px;margin:0 auto}
    .row{display:flex;gap:16px;align-items:flex-start}
    .card{border:1px solid #ddd;border-radius:10px;padding:14px;background:#fff;flex:1}
    h1{margin:0 0 10px 0}
    .muted{color:#666;font-size:12px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid #eee;padding:8px 6px;vertical-align:top}
    th{text-align:left;background:#f6f6f6}
    td.r, th.r{text-align:right}
    td.c, th.c{text-align:center}
    input[type="number"]{width:90px;padding:6px}
    .btn{padding:10px 14px;border-radius:8px;border:1px solid #222;background:#222;color:#fff;cursor:pointer}
    .btn.secondary{background:#fff;color:#222}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .topBar{display:flex;justify-content:space-between;align-items:flex-end;gap:10px}
    .pill{display:inline-block;padding:4px 8px;border:1px solid #ddd;border-radius:999px;font-size:12px;color:#444}
    .totals{margin-top:12px;max-width:380px;margin-left:auto}
    .trow{display:grid;grid-template-columns:1fr 14px 140px;column-gap:8px;margin:6px 0;font-weight:800}
    .trow .colon{text-align:center}
    .trow .val{text-align:right;font-weight:700}
    .error{color:#b00020;font-weight:700;margin-top:10px}
    .ok{color:#0a7b2e;font-weight:700;margin-top:10px}
  </style>
</head>
<body>
<div class="wrap">
  <div class="topBar">
    <div>
      <h1>Teklif Onay</h1>
      <div class="muted" id="meta"></div>
    </div>
    <div>
      <span class="pill" id="statusPill">yükleniyor...</span>
    </div>
  </div>

  <div class="row" style="margin-top:14px;">
    <div class="card">
      <div class="muted">Teklif Satırları (iskonto değişince net otomatik, neti istersen elle de değiştir)</div>
      <table id="tbl">
        <thead>
          <tr>
            <th style="width:14%">Kod</th>
            <th>Ürün</th>
            <th class="c" style="width:8%">Çap</th>
            <th class="c" style="width:8%">Adet</th>
            <th class="r" style="width:12%">Liste Fiyatı</th> <!-- ✅ -->
            <th class="c" style="width:10%">İskonto %</th>
            <th class="r" style="width:12%">Net</th>
            <th class="r" style="width:12%">Tutar</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="totals" id="totals"></div>

      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:14px;">
        <button class="btn secondary" id="btnRecalc" type="button">Yeniden Hesapla</button>
        <button class="btn" id="btnApprove" type="button">Siparişi Onayla</button>
      </div>

      <div class="error" id="err" style="display:none;"></div>
      <div class="ok" id="ok" style="display:none;"></div>
    </div>
  </div>
</div>

<script>
  // ✅ Burayı kendi n8n URL’lerinle değiştir
  const OFFER_GET_URL = "https://4idgxnjs.rpcl.app/webhook-test/offer-get";
  const APPROVE_URL   = "https://4idgxnjs.rpcl.app/webhook-test/offer-approve";

  const qs = new URLSearchParams(location.search);
  const offerId = qs.get("offerId") || "";
  const adminKey = qs.get("adminKey") || "";

  const metaEl = document.getElementById("meta");
  const statusPill = document.getElementById("statusPill");
  const tbody = document.querySelector("#tbl tbody");
  const totalsEl = document.getElementById("totals");
  const errEl = document.getElementById("err");
  const okEl = document.getElementById("ok");
  const btnApprove = document.getElementById("btnApprove");
  const btnRecalc = document.getElementById("btnRecalc");

  function showErr(msg){ errEl.style.display="block"; errEl.textContent=msg; okEl.style.display="none"; }
  function showOk(msg){ okEl.style.display="block"; okEl.textContent=msg; errEl.style.display="none"; }
  function money(n, cur){
    const v = Number(n||0);
    return v.toFixed(2).replace(".", ",") + " " + (cur||"€");
  }

  // Rule: iskonto değişince net otomatik; net elle değişince manualNet=true
  function calcNet(liste, iskonto){
    const L = Number(liste||0);
    const d = Number(iskonto||0);
    return L * (1 - d/100);
  }

  let offer = null;

  async function loadOffer(){
    if(!offerId || !adminKey){
      showErr("Geçersiz link (offerId/adminKey eksik).");
      return;
    }

    statusPill.textContent = "yükleniyor...";
    metaEl.textContent = "";

    const url = `${OFFER_GET_URL}?offerId=${encodeURIComponent(offerId)}&adminKey=${encodeURIComponent(adminKey)}`;
    const res = await fetch(url, { method:"GET" });
    const data = await res.json();

    if(!data || !data.success || !data.offer){
      throw new Error("Teklif verisi alınamadı.");
    }

    offer = data.offer;

    function parseTRNumber(v) {
    if (v === null || v === undefined) return 0;
    if (typeof v === "number" && Number.isFinite(v)) return v;

    let s = String(v).trim();

    // Para birimi ve boşlukları sil (₺, €, TRY, EUR vs)
    s = s.replace(/[^\d.,-]/g, "");

    // "1.234,56" => "1234.56"
    if (s.includes(".") && s.includes(",")) {
      s = s.replace(/\./g, "").replace(",", ".");
    } else if (s.includes(",")) {
      // "1,14" => "1.14"
      s = s.replace(",", ".");
    }

    const n = Number(s);
    return Number.isFinite(n) ? n : 0;
  }

  // offer.lines içindeki tüm numeric alanları düzelt
  function normalizeOfferLines(offer) {
    offer.lines = (offer.lines || []).map(l => ({
      ...l,
      adet: parseTRNumber(l.adet),
      liste: parseTRNumber(l.liste),
      iskonto: parseTRNumber(l.iskonto),
      net: parseTRNumber(l.net),
      tutar: parseTRNumber(l.tutar) // boşsa birazdan zaten net*adet ile hesaplanacak
    }));
  }
    normalizeOfferLines(offer); // varsa kalsın
    hydrateLines(offer);   
    renderTable();
    recalcTotals();     
    const cur = offer.currency || "€";                 // ✅ para birimi buradan
    statusPill.textContent = offer.status || "draft";
    metaEl.textContent = `Teklif No: ${offer.offerId} • Para birimi: ${cur} • Müşteri: ${offer.customerName || "-"} • Telefon: ${(offer.phone||"").replace(/^whatsapp:/i,"") || "-"}`;


  }

  function renderTable(){
    const cur = offer.currency || "€";
    tbody.innerHTML = "";

    (offer.lines || []).forEach((l, idx) => {
      const tr = document.createElement("tr");

      const liste = Number(l.liste||0);
      const iskonto = Number(l.iskonto||0);
      const net = Number(l.net||0);
      const adet = Number(l.adet||0);

      tr.innerHTML = `
        <td><strong>${l.kod||""}</strong></td>
        <td>${l.urun||""}</td>
        <td class="c">${l.cap||""}</td>
        <td class="c">${adet}</td>

        <td class="r">${money(liste, cur)}</td>

        <td class="c">
          <input type="number" min="0" max="100" step="1" value="${iskonto}" data-idx="${idx}" data-field="iskonto">
        </td>

        <td class="r">
          <input type="number" step="0.01" value="${net}" data-idx="${idx}" data-field="net">
        </td>

        <td class="r" data-idx="${idx}" data-field="tutar">${money((net*adet), cur)}</td>
      `;

      tbody.appendChild(tr);
    });

    // Event binding
    tbody.querySelectorAll('input[data-field="iskonto"]').forEach(inp=>{
      inp.addEventListener("input", e=>{
        const i = Number(e.target.dataset.idx);
        const val = Number(e.target.value||0);
        offer.lines[i].iskonto = val;

        // ✅ iskonto değişince net otomatik (manualNet=false)
        offer.lines[i].net = calcNet(offer.lines[i].liste, val);
        offer.lines[i].manualNet = false;

        // net input’u da güncelle
        const netInp = tbody.querySelector(`input[data-idx="${i}"][data-field="net"]`);
        if(netInp) netInp.value = Number(offer.lines[i].net||0).toFixed(2);

        updateLineTotal(i);
        recalcTotals();
      });
    });

    tbody.querySelectorAll('input[data-field="net"]').forEach(inp=>{
      inp.addEventListener("input", e=>{
        const i = Number(e.target.dataset.idx);
        const val = Number(e.target.value||0);
        offer.lines[i].net = val;

        // ✅ net elle değişti: manualNet=true
        offer.lines[i].manualNet = true;

        updateLineTotal(i);
        recalcTotals();
      });
    });
  }

  function updateLineTotal(i){
    const cur = offer.currency || "€";
    const l = offer.lines[i];
    const tutar = Number(l.net||0) * Number(l.adet||0);
    l.tutar = tutar;

    const cell = tbody.querySelector(`td[data-idx="${i}"][data-field="tutar"]`);
    if(cell) cell.textContent = money(tutar, cur);
  }

    function hydrateLines(offer) {
    offer.lines = (offer.lines || []).map(l => {
      const adet = parseTRNumber(l.adet);
      const liste = parseTRNumber(l.liste);
      const iskonto = parseTRNumber(l.iskonto);
      const net = parseTRNumber(l.net);

      // ✅ kritik: ilk açılışta tutar yoksa / stringse hesapla
      const tutar = net * adet;

      return { ...l, adet, liste, iskonto, net, tutar };
    });
  }

  function recalcTotals(){
    const cur = offer.currency || "€";
    const sub = (offer.lines||[]).reduce((s,l)=> s + (Number(l.tutar||0)), 0);
    const kdv = sub * 0.20;
    const grand = sub + kdv;

    totalsEl.innerHTML = `
      <div class="trow"><div>Ara Toplam</div><div class="colon">:</div><div class="val">${money(sub, cur)}</div></div>
      <div class="trow"><div>KDV %20</div><div class="colon">:</div><div class="val">${money(kdv, cur)}</div></div>
      <div class="trow"><div>Genel Toplam</div><div class="colon">:</div><div class="val">${money(grand, cur)}</div></div>
    `;

    offer.total = sub;
  }

  btnRecalc.addEventListener("click", ()=>{
    renderTable();
    recalcTotals();
    showOk("Hesap güncellendi.");
  });

  btnApprove.addEventListener("click", async ()=>{
    try{
      btnApprove.disabled = true;
      showOk("Onay gönderiliyor...");

      const payload = {
        offerId,
        adminKey,
        action: "approve",
        lines: (offer.lines||[]).map(l => ({
          kod: l.kod,
          urun: l.urun,
          cap: l.cap,
          adet: Number(l.adet||0),
          liste: Number(l.liste||0),
          iskonto: Number(l.iskonto||0),
          net: Number(l.net||0),
          manualNet: !!l.manualNet,
          tutar: Number(l.tutar||0),
        })),
        total: Number(offer.total||0),
        currency: offer.currency || "€",           // ✅ para birimi doğru gönder
        phone: offer.phone || "",
        customerName: offer.customerName || ""
      };

      const res = await fetch(APPROVE_URL, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });

      const data = await res.json().catch(()=> ({}));
      if(!res.ok || !data || data.success === false){
        throw new Error(data.error || data.message || "Approve hatası");
      }

      showOk("Onaylandı. PDF hazırlanıp müşteriye gönderilecektir.");
    }catch(e){
      showErr(String(e.message || e));
    }finally{
      btnApprove.disabled = false;
    }
  });

  (async ()=>{
    try{
      await loadOffer();
    }catch(e){
      showErr("Teklif yüklenemedi: " + (e.message || e));
    }
  })();
</script>
</body>
</html>
